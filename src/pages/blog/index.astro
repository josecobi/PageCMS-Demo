---
import Layout from '../../layouts/Layout.astro';
import BlogCard from '../../components/BlogCard.astro';
import { getCollection } from 'astro:content';

// Get all blog posts
const allPosts = await getCollection('blog');
const sortedPosts = allPosts.sort((a, b) =>
  b.data.publishDate.getTime() - a.data.publishDate.getTime()
);

// Get all unique tags
const allTags = [...new Set(allPosts.flatMap(post => post.data.tags))].sort();

// Get tag from URL if filtering
const urlParams = Astro.url.searchParams;
const selectedTag = urlParams.get('tag');

// Filter posts by tag if selected
const filteredPosts = selectedTag
  ? sortedPosts.filter(post => post.data.tags.includes(selectedTag))
  : sortedPosts;

const featuredPosts = sortedPosts.filter(post => post.data.featured);
---

<Layout
  title="News & Updates - Fells Prospect Community Association"
  description="Read the latest news, updates, and stories from the Fells Prospect neighborhood."
>
  <!-- Hero Section -->
  <section class="relative py-20 md:py-28 overflow-hidden" style="background: linear-gradient(135deg, #C1503D 0%, #A84636 100%);">
    <!-- Fox Silhouette - Bottom left emerging -->
    <div class="absolute -bottom-20 left-8 md:left-16 h-96 w-auto opacity-15 pointer-events-none" style="filter: brightness(0) saturate(100%) invert(98%) sepia(4%) saturate(352%) hue-rotate(343deg) brightness(103%) contrast(96%);">
      <img src="/images/fox.svg" alt="" class="h-full w-auto" />
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center relative z-10">
      <h1 class="text-5xl md:text-6xl font-bold mb-6" style="font-family: Georgia, serif; color: #FAF8F4;">
        News & Updates
      </h1>
      <p class="text-xl md:text-2xl max-w-3xl mx-auto" style="color: #EFE9DC;">
        Stories, updates, and insights from the Fells Prospect community
      </p>
    </div>

    <!-- Decorative bottom -->
    <div class="absolute bottom-0 left-0 right-0">
      <svg viewBox="0 0 1440 60" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-full">
        <path d="M0 0L60 5C120 10 240 20 360 23.3C480 27 600 23 720 21.7C840 20 960 20 1080 23.3C1200 27 1320 33 1380 36.7L1440 40V60H0V0Z" fill="#FAF8F4"/>
      </svg>
    </div>
  </section>

  <!-- Main Content -->
  <section class="py-12 md:py-16" style="background-color: #FAF8F4;">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <!-- Tag Filter -->
      {allTags.length > 0 && (
        <div class="mb-12">
          <h2 class="text-lg font-semibold mb-4" style="color: #3E2723;">Filter by Topic</h2>
          <div class="flex flex-wrap gap-3">
            <a
              href="/blog"
              class="px-4 py-2 rounded-full transition-all"
              style={!selectedTag
                ? 'background-color: #2D5832; color: #FAF8F4;'
                : 'background-color: #EFE9DC; color: #3E2723;'}
              onmouseover={!selectedTag ? '' : "this.style.backgroundColor='#E5DFD0'"}
              onmouseout={!selectedTag ? '' : "this.style.backgroundColor='#EFE9DC'"}
            >
              All Posts
            </a>
            {allTags.map(tag => (
              <a
                href={`/blog?tag=${encodeURIComponent(tag)}`}
                class="px-4 py-2 rounded-full transition-all"
                style={selectedTag === tag
                  ? 'background-color: #2D5832; color: #FAF8F4;'
                  : 'background-color: #EFE9DC; color: #3E2723;'}
                onmouseover={selectedTag === tag ? '' : "this.style.backgroundColor='#E5DFD0'"}
                onmouseout={selectedTag === tag ? '' : "this.style.backgroundColor='#EFE9DC'"}
              >
                {tag}
              </a>
            ))}
          </div>
        </div>
      )}

      <!-- Featured Posts -->
      {!selectedTag && featuredPosts.length > 0 && (
        <div class="mb-16">
          <h2 class="text-3xl md:text-4xl font-bold mb-8" style="font-family: Georgia, serif; color: #C1503D;">Featured Stories</h2>
          <div class="grid md:grid-cols-2 gap-8">
            {featuredPosts.slice(0, 2).map(post => (
              <BlogCard
                title={post.data.title}
                description={post.data.description}
                publishDate={post.data.publishDate}
                author={post.data.author}
                slug={post.slug}
                image={post.data.image}
                imageAlt={post.data.imageAlt}
                tags={post.data.tags}
              />
            ))}
          </div>
        </div>
      )}

      <!-- All Posts -->
      <div>
        <h2 class="text-3xl md:text-4xl font-bold mb-8" style="font-family: Georgia, serif; color: #2D5832;">
          {selectedTag ? `Posts tagged "${selectedTag}"` : 'All Posts'}
        </h2>

        {filteredPosts.length > 0 ? (
          <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
            {filteredPosts.map(post => (
              <BlogCard
                title={post.data.title}
                description={post.data.description}
                publishDate={post.data.publishDate}
                author={post.data.author}
                slug={post.slug}
                image={post.data.image}
                imageAlt={post.data.imageAlt}
                tags={post.data.tags}
              />
            ))}
          </div>
        ) : (
          <div class="text-center py-12">
            <p class="text-xl" style="color: #4A3933;">
              {selectedTag
                ? `No posts found with tag "${selectedTag}"`
                : 'No blog posts yet. Check back soon!'}
            </p>
          </div>
        )}
      </div>
    </div>
  </section>
</Layout>
